<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Transfer Insights - By IPI</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{font-family:"Aptos","Segoe UI",Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px 24px;align-items:start}
    .inline{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center} .inline span{color:var(--text-light)}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .loading{opacity:.6;pointer-events:none}
    .future-date{color:#ccc;cursor:not-allowed}
    
    .tab-container { margin-top: 20px; }
    .tab-buttons { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .tab-button { padding: 10px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-light); border-bottom: 3px solid transparent; transition: all 0.2s; }
    .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .transfer-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .transfer-stat-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; text-align: center; }
    .transfer-stat-number { font-size: 24px; color: var(--primary-color); font-weight: 700; margin-bottom: 8px; }
    .transfer-stat-label { font-size: 14px; color: var(--text-light); }
    
    .queue-transfer-matrix { overflow-x: auto; margin-top: 20px; }
    .matrix-table { border-collapse: collapse; width: 100%; min-width: 600px; }
    .matrix-table th, .matrix-table td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
    .matrix-table th { background-color: var(--primary-color); color: white; font-weight: 600; }
    .matrix-table th.from-header { background-color: var(--secondary-color); }
    .matrix-table th.to-header { background-color: var(--primary-color); }
    .matrix-table td.from-label { background-color: var(--light-bg); font-weight: 600; text-align: left; }
    .matrix-table tr:hover td { background-color: #f0f7f4; }
    .matrix-count { font-weight: 600; color: var(--text-color); }
    .matrix-high { background-color: #fee2e2 !important; }
    .matrix-medium { background-color: #fef3c7 !important; }
    .matrix-low { background-color: #d1fae5 !important; }
    
    .conversation-transfer-group { 
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .conversation-transfer-header { 
      background-color: var(--light-bg);
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
    }
    .conversation-transfer-count {
      background-color: var(--primary-color);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 8px;
    }
    .conversation-transfer-details {
      display: none;
      background-color: white;
    }
    .conversation-transfer-details.open {
      display: block;
    }
    .transfer-leg {
      padding: 10px 16px;
      border-bottom: 1px solid var(--light-bg);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .transfer-leg:last-child {
      border-bottom: none;
    }
    .transfer-leg-number {
      background-color: var(--light-bg);
      color: var(--text-color);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    .transfer-leg-content {
      flex: 1;
    }
    .transfer-leg-arrow {
      color: var(--primary-color);
      font-weight: 600;
      margin: 0 8px;
    }
    
    .agent-selector { margin-bottom: 16px; }
    .agent-selector label { display: inline-block; margin-right: 12px; }
    .agent-selector select { min-width: 200px; }
    
    .filter-controls { display: flex; gap: 12px; margin-bottom: 16px; }
    .filter-controls select { min-width: 200px; }
    .filter-controls input { flex: 1; }
    
    .progress-bar{width:100%;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:var(--primary-color);transition:width .3s}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Transfer Insights - By IPI</h1>
  <button id="signinBtn" style="display:none;margin-bottom:12px;">Sign in to Genesys Cloud</button>

  <div id="authStatus" class="card" style="display:none;">
    <div style="text-align:center;padding:20px;">
      <div style="font-size:18px;color:var(--secondary-color);margin-bottom:8px;">üîê Authenticating‚Ä¶</div>
      <div class="muted">Connecting to Genesys Cloud</div>
    </div>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 12px;">Select Agent & Date Range</h2>
      <div class="controls">
        <div>
          <label for="agentSelect">Select Agent</label>
          <select id="agentSelect"><option>Loading users‚Ä¶</option></select>
          <input id="agentFilter" type="text" placeholder="Filter users by name" style="margin-top:8px"/>
        </div>
        <div>
          <label>Date Range</label>
          <div class="inline">
            <input id="fromDate" type="date"/>
            <span>to</span>
            <input id="toDate" type="date"/>
          </div>
          <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
            <input id="autoChunk" type="checkbox" checked/> Auto-split large date ranges (recommended)
          </label>
        </div>
      </div>
      <button id="fetchBtn" class="full-width-btn">Fetch Transfers</button>
    </div>

    <div id="statusMessage" class="muted" style="margin-top:10px;"></div>
    <div id="errorMessage" style="color:#dc2626;margin-top:6px;"></div>

    <div id="progressSection" style="display:none;">
      <div class="card">
        <h3 style="margin:0 0 8px;">Fetching Conversations</h3>
        <div class="muted" id="chunkInfo">Processing date range in smaller chunks‚Ä¶</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:14px" class="muted">
          <span id="progressText">0%</span><span id="chunkText">Chunk 0/0</span>
        </div>
      </div>
    </div>

    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="transfers">Agent Transfer Reporting</button>
        <button class="tab-button" data-tab="queue-transfer-matrix">Queue Transfer Matrix</button>
        <button class="tab-button" data-tab="agent-transfer-matrix">Agent Transfer Matrix</button>
      </div>
      
      <div id="transfers-tab" class="tab-content active">
        <div class="card">
          <h2 style="margin:0 0 12px;">Agent Transfer Reporting</h2>
          <div class="filter-controls">
            <select id="transferFilter">
              <option value="all">All Agent-Initiated Transfers</option>
              <option value="agent-to-agent">Agent ‚Üí Agent</option>
              <option value="agent-to-queue">Agent ‚Üí Queue</option>
            </select>
            <input type="text" id="transferSearch" placeholder="Search by conversation ID">
          </div>
          
          <div id="transferStats" class="transfer-stats"></div>
          <div id="transferTableContainer"></div>
          
          <div id="noTransfersMessage" style="display:none; text-align:center; padding:40px;">
            <div style="font-size:48px;margin-bottom:12px">üîÑ</div>
            <div>No transfers found for the selected criteria.</div>
          </div>
        </div>
      </div>
      
      <div id="queue-transfer-matrix-tab" class="tab-content">
        <div class="card">
          <h2 style="margin:0 0 12px;">Queue Transfer Matrix</h2>
          
          <div class="agent-selector">
            <label for="queueMatrixAgentSelect">Show transfers for:</label>
            <select id="queueMatrixAgentSelect">
              <option value="all">All Agents</option>
            </select>
          </div>
          
          <div id="queueMatrixStats" class="transfer-stats"></div>
          <div id="queueMatrixContainer" class="queue-transfer-matrix"></div>
          
          <div id="noQueueMatrixDataMessage" style="display:none; text-align:center; padding:40px;">
            <div style="font-size:48px;margin-bottom:12px">üìä</div>
            <div>No queue transfer data available for the selected criteria.</div>
          </div>
        </div>
      </div>
      
      <div id="agent-transfer-matrix-tab" class="tab-content">
        <div class="card">
          <h2 style="margin:0 0 12px;">Agent Transfer Matrix</h2>
          
          <div class="agent-selector">
            <label for="agentMatrixAgentSelect">Show transfers for:</label>
            <select id="agentMatrixAgentSelect">
              <option value="all">All Agents</option>
            </select>
          </div>
          
          <div id="agentMatrixStats" class="transfer-stats"></div>
          <div id="agentMatrixContainer" class="queue-transfer-matrix"></div>
          
          <div id="noAgentMatrixDataMessage" style="display:none; text-align:center; padding:40px;">
            <div style="font-size:48px;margin-bottom:12px">üë•</div>
            <div>No agent transfer data available for the selected criteria.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config (Ireland) =====
    // IMPORTANT: You need to create a new OAuth client in Genesys Cloud for this app
    // or update the redirect URI to match where this app is hosted
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      redirectUri: window.location.origin + window.location.pathname, // Dynamic redirect URI
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // ===== State =====
    const state = { 
      token:null, 
      users:[], 
      queues:{}, 
      conversations:[], 
      selectedAgent:null, 
      convIndex:{},
      allTransfers: [],
      queueTransfers: [],
      agentTransfers: []
    };

    // ===== Utils =====
    const $ = id => document.getElementById(id);
    const setStatus = (msg,err=false)=>{ $('statusMessage').textContent = err?'':(msg||''); $('errorMessage').textContent = err?(msg||''):''; };
    const fmt = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleString()}catch{return 'N/A'} };
    const fmtDMY = s => { if(!s||s.length<10) return s||''; const [y,m,d]=s.slice(0,10).split('-'); return `${d}-${m}-${y}`; };
    const formatSeconds = ms => { if(!ms) return '0s'; const s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60); if(h) return `${h}h ${m%60}m ${s%60}s`; if(m) return `${m}m ${s%60}s`; return `${s}s`; };
    function showMain(){ $('authStatus').style.display='none'; $('mainContent').style.display='block'; }
    function setLoading(v){ $('mainContent').classList.toggle('loading', !!v); }
    function updateProgress(p,cur,total){ $('progressFill').style.width = `${p}%`; $('progressText').textContent = `${Math.round(p)}%`; $('chunkText').textContent = `Chunk ${cur}/${total}`; }
    function showProgress(){ $('progressSection').style.display='block'; }
    function hideProgress(){ $('progressSection').style.display='none'; }

    // ===== Date Range Limiting =====
    function setupDateLimits() {
      const today = new Date().toISOString().split('T')[0];
      $('fromDate').max = today; $('toDate').max = today;
      $('fromDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('toDate').value && this.value > $('toDate').value) $('toDate').value = this.value;
      });
      $('toDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('fromDate').value && this.value < $('fromDate').value) $('fromDate').value = this.value;
      });
    }

    // ===== Tabs =====
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          button.classList.add('active');
          const tabId = button.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.add('active');
        });
      });
    }

    // ===== Auth =====
    function parseTokenFromHash(){
      const params = new URLSearchParams(location.hash.replace(/^#/, ''));
      return { 
        token: params.get('access_token'), 
        error: params.get('error'), 
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }
    
    function authUrl(){
      return `${CONFIG.loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    
    function initAuth(){
      console.log('Initializing auth...');
      console.log('Current URL:', window.location.href);
      console.log('Redirect URI:', CONFIG.redirectUri);
      
      const {token, error, errorDescription, expiresIn} = parseTokenFromHash();
      
      if(location.hash) {
        console.log('Hash found in URL:', location.hash.substring(0, 100) + '...');
        history.replaceState(null, '', location.pathname + location.search);
      }

      if(token){
        console.log('Token received via OAuth redirect');
        sessionStorage.removeItem('gc_auto_auth_attempted');
        state.token = token; 
        
        // Store token in sessionStorage for persistence
        sessionStorage.setItem('gc_token', token);
        if (expiresIn) {
          const expiryTime = Date.now() + (parseInt(expiresIn) * 1000);
          sessionStorage.setItem('gc_token_expiry', expiryTime.toString());
        }
        
        showMain(); 
        setupDateLimits(); 
        setupTabs(); 
        fetchAllUsers();
        return;
      }

      // Check if we have a stored token
      const storedToken = sessionStorage.getItem('gc_token');
      const storedExpiry = sessionStorage.getItem('gc_token_expiry');
      
      if (storedToken && storedExpiry && Date.now() < parseInt(storedExpiry)) {
        console.log('Using stored token');
        state.token = storedToken;
        showMain();
        setupDateLimits();
        setupTabs();
        fetchAllUsers();
        return;
      }

      // Clear expired token
      if (storedToken) {
        sessionStorage.removeItem('gc_token');
        sessionStorage.removeItem('gc_token_expiry');
      }

      const attempted = sessionStorage.getItem('gc_auto_auth_attempted');
      if(!attempted && !error){
        console.log('No stored token, attempting auto-auth');
        sessionStorage.setItem('gc_auto_auth_attempted','1');
        location.assign(authUrl());
        return;
      }

      if (error) {
        console.error('OAuth error:', error, errorDescription);
        setStatus(`Authentication failed: ${errorDescription || error}`, true);
      }

      $('signinBtn').style.display = 'inline-block';
      $('signinBtn').onclick = () => { 
        sessionStorage.setItem('gc_auto_auth_attempted','1'); 
        location.assign(authUrl()); 
      };
      $('authStatus').style.display = 'none';
    }

    // ===== API helper =====
    async function api(path){
      if(!state.token) throw new Error('Not authenticated');
      const res = await fetch(`${CONFIG.apiHost}${path}`, { 
        headers:{
          Authorization:`Bearer ${state.token}`,
          'Content-Type': 'application/json'
        } 
      });
      if(res.status===401||res.status===403) {
        // Token expired, clear and retry auth
        sessionStorage.removeItem('gc_token');
        sessionStorage.removeItem('gc_token_expiry');
        sessionStorage.removeItem('gc_auto_auth_attempted');
        location.reload();
        throw new Error(`Authentication error (${res.status}). Please refresh.`);
      }
      if(!res.ok){ 
        const t = await res.text().catch(()=> ''); 
        throw new Error(`API Error: ${res.status} ${res.statusText}${t?` - ${t.slice(0,200)}`:''}`); 
      }
      return res.json();
    }

    // ===== Users =====
    async function fetchAllUsers(){
      try{
        setStatus('Loading users‚Ä¶'); setLoading(true);
        let all=[], page=1, size=100;
        while(true){
          const data = await api(`/api/v2/users?pageSize=${size}&pageNumber=${page}`);
          const ents = data?.entities||[]; all = all.concat(ents);
          if(!data?.nextUri || ents.length<size) break; page++;
        }
        state.users = all.map(u=>({id:u.id,name:u.name||'',email:u.email||''})).sort((a,b)=>a.name.localeCompare(b.name));
        populateUserSelect(state.users);
        populateMatrixAgentSelects(state.users);
        setStatus(`Loaded ${state.users.length} users`); setLoading(false);
      }catch(e){ 
        console.error('Error loading users:', e);
        setStatus(`Failed to load users: ${e.message}`, true); 
        setLoading(false); 
        $('agentSelect').innerHTML='<option>Failed to load users</option>'; 
      }
    }
    
    function populateUserSelect(users){
      const sel=$('agentSelect');
      sel.innerHTML = '<option value="">Select an agent‚Ä¶</option>' + users.map(u=>`<option value="${u.id}">${u.name||'(Unnamed)'}</option>`).join('');
      sel.onchange=()=>{ 
        const u = users.find(x=>x.id===sel.value); 
        state.selectedAgent=u||null; 
      };
    }
    
    function populateMatrixAgentSelects(users) {
      const queueSel = $('queueMatrixAgentSelect');
      const agentSel = $('agentMatrixAgentSelect');
      const options = '<option value="all">All Agents</option>' + 
        users.map(u => `<option value="${u.id}">${u.name || '(Unnamed)'}</option>`).join('');
      queueSel.innerHTML = options;
      agentSel.innerHTML = options;
    }
    
    $('agentFilter').addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      populateUserSelect(q ? state.users.filter(u=>(u.name||'').toLowerCase().includes(q)) : state.users);
    });

    // ===== Chunking =====
    function chunks(start,end,days){
      const out=[]; const s=new Date(start), e=new Date(end); let cur=new Date(s);
      while(cur<=e){ 
        let ce=new Date(cur); 
        ce.setDate(ce.getDate()+days-1); 
        if(ce>e) ce=new Date(e);
        out.push({
          start:cur.toISOString().slice(0,10), 
          end:ce.toISOString().slice(0,10)
        }); 
        cur.setDate(cur.getDate()+days);
      } 
      return out;
    }
    
    function optimalDays(start,end){
      const s=new Date(start), e=new Date(end), total=Math.ceil((e-s)/(1000*60*60*24))+1;
      if(total<=7) return 7; 
      if(total<=30) return 7; 
      if(total<=90) return 5; 
      if(total<=180) return 3; 
      return 2;
    }

    // ===== Queue helpers =====
    function getQueueIdFromParticipant(p){ 
      if(p.queueId) return p.queueId; 
      for(const s of (p.sessions||[])) {
        if(s.queueId) return s.queueId;
        for(const seg of (s.segments||[])) {
          if(seg.queueId) return seg.queueId;
        }
      }
      return null; 
    }

    function getQueueName(id){ 
      if (!id) return null;
      const name = state.queues[id];
      if (name) return name;
      return `Queue ${id.substring(0, 8)}...`;
    }

    function isPlaceholderQueueName(name){
      return !name || name === 'Unknown Queue';
    }
    
    function getKnownQueueName(id){
      const name = state.queues[id];
      if (isPlaceholderQueueName(name)) return null;
      return name;
    }

    async function fetchQueueNames(queueIds) {
      if (!queueIds || queueIds.length === 0) return;
      const queuesToFetch = queueIds.filter(id => !state.queues[id]);
      if (queuesToFetch.length === 0) return;
      
      const batchSize = 10;
      for (let i = 0; i < queuesToFetch.length; i += batchSize) {
        const batch = queuesToFetch.slice(i, i + batchSize);
        const promises = batch.map(async (queueId) => {
          try {
            const queue = await api(`/api/v2/routing/queues/${queueId}`);
            if (queue && queue.name) {
              state.queues[queueId] = queue.name;
            }
          } catch (e) {
            console.warn(`Could not fetch queue name for ${queueId}:`, e);
            state.queues[queueId] = 'Unknown Queue';
          }
        });
        await Promise.all(promises);
        if (i + batchSize < queuesToFetch.length) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
    }

    async function warmQueueCache(convs) {
      const queueIds = new Set(); 
      for(const c of convs) {
        for(const p of (c.participants||[])){ 
          if((p.purpose || '').toLowerCase() === 'acd'){
            const id = getQueueIdFromParticipant(p); 
            if(id) queueIds.add(id); 
          }
        }
      }
      await fetchQueueNames([...queueIds]);
    }

    function getUserNameById(id){
      const u = state.users.find(u => u.id === id);
      return u ? u.name : `Agent ${id}`;
    }

    // ===== Conversation helpers =====
    function getStepStart(p){
      let t=[]; 
      for(const s of (p.sessions||[])){
        if(s.startTime){ 
          const v=+new Date(s.startTime); 
          if(!isNaN(v)) t.push(v); 
        }
        for(const seg of (s.segments||[])){
          if(seg.segmentStart){ 
            const v=+new Date(seg.segmentStart); 
            if(!isNaN(v)) t.push(v); 
          }
          for(const ev of (seg.events||[])) if(ev.eventTime){ 
            const v=+new Date(ev.eventTime); 
            if(!isNaN(v)) t.push(v); 
          }
        }
      }
      return t.length? new Date(Math.min(...t)) : null;
    }

    // ===== Agent transfer detection =====
    function isAgentTransferInitiated(fromParticipant, toParticipant) {
      for (const session of (fromParticipant.sessions || [])) {
        for (const segment of (session.segments || [])) {
          for (const event of (segment.events || [])) {
            if (event.eventType && (
              event.eventType.toLowerCase().includes('transfer') ||
              event.eventType.toLowerCase().includes('redirect') ||
              (event.type && event.type.toLowerCase().includes('transfer'))
            )) {
              return true;
            }
          }
        }
      }
      const fromStart = getStepStart(fromParticipant);
      const toStart = getStepStart(toParticipant);
      if (fromStart && toStart) {
        const timeBetween = toStart.getTime() - fromStart.getTime();
        if (timeBetween < 10000) {
          return false;
        }
      }
      return true;
    }

    // ===== analyzeTransfers: only agent-initiated (Agent‚ÜíAgent, Agent‚ÜíQueue) =====
    function analyzeTransfers(c){
      const transfers = [];
      const timeline = [];
      
      for(const p of (c.participants||[])){
        const queueId = getQueueIdFromParticipant(p);
        const startTime = getStepStart(p);
        const purpose = (p.purpose || '').toLowerCase();
        const name = (p.name || '').toLowerCase();
        
        if (purpose.includes('ivr') || purpose.includes('survey') ||
            name.includes('ivr') || name.includes('survey')) {
          continue;
        }
        
        if(startTime && (queueId || p.userId)) {
          timeline.push({
            time: startTime.getTime(),
            participant: p,
            queueId,
            userId: p.userId
          });
        }
      }
      
      timeline.sort((a, b) => a.time - b.time);
      
      for(let i = 1; i < timeline.length; i++) {
        const prev = timeline[i-1];
        const curr = timeline[i];
        if(!prev || !curr) continue;
        
        // Only consider transfers where the FROM side is an agent
        if (!prev.userId) continue;
        
        const fromId = prev.userId;
        const fromName = getUserNameById(prev.userId);
        const fromType = 'Agent';
        
        let toId, toName, toType, type, isAgentInitiated = true;
        
        if (curr.userId) {
          // Agent ‚Üí Agent
          const agentInitiated = isAgentTransferInitiated(prev.participant, curr.participant);
          if (!agentInitiated) continue;
          toId = curr.userId;
          toName = getUserNameById(curr.userId);
          toType = 'Agent';
          type = 'Agent ‚Üí Agent';
        } else if (curr.queueId) {
          // Agent ‚Üí Queue
          toId = curr.queueId;
          toName = getQueueName(curr.queueId) || `Queue ${curr.queueId}`;
          toType = 'Queue';
          type = 'Agent ‚Üí Queue';
          isAgentInitiated = true;
        } else {
          continue;
        }
        
        if (!toId || fromId === toId) continue;
        
        transfers.push({
          step: i,
          fromId,
          toId,
          fromName,
          toName,
          fromType,
          toType,
          time: new Date(curr.time).toISOString(),
          type,
          conversationId: c.conversationId,
          isAgentInitiated
        });
      }
      
      return {totalTransfers: transfers.length, transfers};
    }

    // ===== Fetch conversations for transfers =====
    async function fetchConversations(){
      try{
        if(!state.selectedAgent){ 
          setStatus('Please select an agent first', true); 
          return; 
        }
        const from=$('fromDate').value, to=$('toDate').value||from;
        if(!from){ 
          setStatus('Please select a start date', true); 
          return; 
        }
        const today = new Date().toISOString().split('T')[0];
        if(from > today || to > today) { 
          setStatus('Date range cannot be in the future', true); 
          return; 
        }

        setStatus('Fetching conversations for transfer analysis‚Ä¶'); 
        setLoading(true);

        const auto=$('autoChunk').checked;
        const days = auto? optimalDays(from,to) : (new Date(to)-new Date(from) >= 0 ? (Math.ceil((new Date(to)-new Date(from))/(1000*60*60*24))+1) : 1);
        const dateChunks = auto? chunks(from,to,days) : [{start:from,end:to}];

        $('chunkInfo').innerHTML = auto
          ? 'Large range: <strong>' + fmtDMY(from) + ' to ' + fmtDMY(to) + '</strong><br>Auto-splitting into <strong>' + dateChunks.length + ' chunks</strong> of ' + days + ' days.'
          : 'Processing range: <strong>' + fmtDMY(from) + ' to ' + fmtDMY(to) + '</strong>';

        showProgress();
        state.conversations=[]; 
        state.convIndex={};
        state.allTransfers = [];
        state.agentTransfers = [];

        for(let i=0;i<dateChunks.length;i++){
          const ch=dateChunks[i]; 
          updateProgress((i/dateChunks.length)*100, i+1, dateChunks.length);
          setStatus('Fetching chunk ' + (i+1) + '/' + dateChunks.length + ': ' + ch.start + ' ‚Üí ' + ch.end);
          try{
            const body = { 
              interval: ch.start + 'T00:00:00/' + ch.end + 'T23:59:59', 
              order:'asc', 
              orderBy:'conversationStart', 
              segmentFilters:[{
                type:'and',
                predicates:[{
                  type:'dimension',
                  dimension:'userId',
                  operator:'matches',
                  value: state.selectedAgent.id 
                }]
              }] 
            };
            const res = await fetch(CONFIG.apiHost + '/api/v2/analytics/conversations/details/query', { 
              method:'POST', 
              headers:{
                Authorization:'Bearer ' + state.token,
                'Content-Type':'application/json'
              }, 
              body:JSON.stringify(body) 
            });
            if(!res.ok){ 
              const t=await res.text().catch(()=> ''); 
              throw new Error('Details error: ' + res.status + ' ' + res.statusText + (t?' - ' + t.slice(0,200):'')); 
            }
            const data = await res.json(); 
            const convs = data.conversations||[];
            
            for(const c of convs) state.convIndex[c.conversationId]=c;
            state.conversations = state.conversations.concat(convs);
            
            // Analyze transfers for each conversation
            for(const conv of convs) {
              const transferAnalysis = analyzeTransfers(conv);
              if(transferAnalysis.transfers.length > 0) {
                state.allTransfers = state.allTransfers.concat(
                  transferAnalysis.transfers.map(t => ({
                    ...t,
                    conversationId: conv.conversationId,
                    conversationStart: conv.conversationStart
                  }))
                );
                
                const agentTransfers = transferAnalysis.transfers.filter(t => 
                  t.type === 'Agent ‚Üí Agent'
                );
                if (agentTransfers.length > 0) {
                  state.agentTransfers = state.agentTransfers.concat(
                    agentTransfers.map(t => ({
                      ...t,
                      conversationId: conv.conversationId,
                      conversationStart: conv.conversationStart
                    }))
                  );
                }
              }
            }
          }catch(e){ 
            console.error('Error in chunk:', e); 
            setStatus('Warning: failed chunk ' + (i+1) + ', continuing‚Ä¶', true); 
          }
          
          // Small delay between chunks to avoid rate limiting
          if(i<dateChunks.length-1) await new Promise(r=>setTimeout(r,400));
        }

        // Fetch queue names for better display
        await warmQueueCache(state.conversations);

        updateProgress(100, dateChunks.length, dateChunks.length);
        
        // Render all transfer views
        renderTransferReport();
        renderQueueTransferMatrix();
        renderAgentTransferMatrix();
        
        setStatus(`Analyzed ${state.conversations.length} conversations, found ${state.allTransfers.length} agent-initiated transfers`);
        setLoading(false); 
        hideProgress();
        
      }catch(e){ 
        console.error('Error fetching conversations:', e);
        setStatus('Error fetching conversations: ' + e.message, true); 
        setLoading(false); 
        hideProgress(); 
      }
    }

    // ===== Transfer Reporting (agent-initiated only, with fresh queue names) =====
    function renderTransferReport() {
      const statsContainer = $('transferStats');
      const tableContainer = $('transferTableContainer');
      const noTransfersMessage = $('noTransfersMessage');

      if (state.allTransfers.length === 0) {
        statsContainer.innerHTML = '';
        tableContainer.innerHTML = '';
        noTransfersMessage.style.display = 'block';
        return;
      }

      noTransfersMessage.style.display = 'none';

      // Re-apply latest queue names based on IDs
      const transfers = state.allTransfers.map(t => {
        const copy = { ...t };

        if (copy.fromType === 'Queue') {
          const qName = getKnownQueueName(copy.fromId) || getQueueName(copy.fromId);
          copy.fromName = qName;
        }
        if (copy.toType === 'Queue') {
          const qName = getKnownQueueName(copy.toId) || getQueueName(copy.toId);
          copy.toName = qName;
        }

        return copy;
      });

      // Stats
      const totalTransfers = transfers.length;
      const agentToAgent = transfers.filter(t => t.type === 'Agent ‚Üí Agent').length;
      const agentToQueue = transfers.filter(t => t.type === 'Agent ‚Üí Queue').length;

      statsContainer.innerHTML = `
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${totalTransfers}</div>
          <div class="transfer-stat-label">Agent-Initiated Transfers</div>
        </div>
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${agentToAgent}</div>
          <div class="transfer-stat-label">Agent ‚Üí Agent</div>
        </div>
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${agentToQueue}</div>
          <div class="transfer-stat-label">Agent ‚Üí Queue</div>
        </div>
      `;

      // Apply filters
      const filterType = $('transferFilter').value;
      const searchTerm = $('transferSearch').value.toLowerCase();

      let filteredTransfers = transfers;

      if (filterType === 'agent-to-agent') {
        filteredTransfers = filteredTransfers.filter(t => t.type === 'Agent ‚Üí Agent');
      } else if (filterType === 'agent-to-queue') {
        filteredTransfers = filteredTransfers.filter(t => t.type === 'Agent ‚Üí Queue');
      }

      if (searchTerm) {
        filteredTransfers = filteredTransfers.filter(t =>
          t.conversationId.toLowerCase().includes(searchTerm)
        );
      }

      // Group by conversation
      const transfersByConversation = {};
      filteredTransfers.forEach(transfer => {
        if (!transfersByConversation[transfer.conversationId]) {
          transfersByConversation[transfer.conversationId] = [];
        }
        transfersByConversation[transfer.conversationId].push(transfer);
      });

      if (Object.keys(transfersByConversation).length === 0) {
        tableContainer.innerHTML =
          '<div style="text-align:center;padding:20px">No transfers match the selected filters</div>';
        return;
      }

      // Nested UI for conversations with transfers
      let html = '';
      Object.entries(transfersByConversation).forEach(([conversationId, convTransfers]) => {
        const sortedTransfers = convTransfers.sort(
          (a, b) => new Date(a.time) - new Date(b.time)
        );

        html += `
          <div class="conversation-transfer-group">
            <div class="conversation-transfer-header" onclick="toggleTransferDetails('${conversationId}')">
              <span>
                ${conversationId}
                <span class="conversation-transfer-count">
                  ${convTransfers.length} transfer${convTransfers.length > 1 ? 's' : ''}
                </span>
              </span>
              <span>${fmt(sortedTransfers[0].conversationStart)}</span>
            </div>
            <div class="conversation-transfer-details" id="transfer-details-${conversationId}">
        `;

        sortedTransfers.forEach((transfer, index) => {
          html += `
            <div class="transfer-leg">
              <div class="transfer-leg-number">${index + 1}</div>
              <div class="transfer-leg-content">
                <strong>${transfer.fromName}</strong>
                <span class="transfer-leg-arrow">‚Üí</span>
                <strong>${transfer.toName}</strong>
                <span style="margin-left: 12px; color: var(--text-light);">
                  ${transfer.type} ‚Ä¢ ${fmt(transfer.time)}
                </span>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      tableContainer.innerHTML = html;
    }
    
    function toggleTransferDetails(conversationId) {
      const details = document.getElementById(`transfer-details-${conversationId}`);
      if (details) {
        details.classList.toggle('open');
      }
    }

    // ===== Queue Transfer Matrix: derive from ACD queue participants only =====
    function computeQueueMatrixTransfers() {
      const transfers = [];
      for (const conv of state.conversations) {
        const queues = [];
        for (const p of (conv.participants || [])) {
          if ((p.purpose || '').toLowerCase() !== 'acd') continue;
          const qid = getQueueIdFromParticipant(p);
          if (!qid) continue;
          const qName = getKnownQueueName(qid);
          if (!qName) continue; // skip unknown queues
          const start = getStepStart(p);
          if (!start) continue;
          queues.push({
            queueId: qid,
            time: start.getTime(),
            conversationId: conv.conversationId,
            conversationStart: conv.conversationStart
          });
        }
        if (queues.length < 2) continue;
        queues.sort((a,b)=>a.time-b.time);
        for (let i=1;i<queues.length;i++) {
          const prev = queues[i-1], curr = queues[i];
          if (prev.queueId === curr.queueId) continue;
          transfers.push({
            fromId: prev.queueId,
            toId: curr.queueId,
            conversationId: conv.conversationId,
            conversationStart: conv.conversationStart
          });
        }
      }
      return transfers;
    }

    function renderQueueTransferMatrix() {
      const statsContainer = $('queueMatrixStats');
      const matrixContainer = $('queueMatrixContainer');
      const noMatrixDataMessage = $('noQueueMatrixDataMessage');
      const selectedAgentId = $('queueMatrixAgentSelect').value;
      
      const allQueueTransfers = computeQueueMatrixTransfers();
      let transfersToShow = allQueueTransfers;
      
      if (selectedAgentId !== 'all') {
        const agentConversations = state.conversations.filter(conv => 
          conv.participants && conv.participants.some(p => p.userId === selectedAgentId)
        );
        const agentConversationIds = new Set(agentConversations.map(c => c.conversationId));
        transfersToShow = transfersToShow.filter(t => agentConversationIds.has(t.conversationId));
      }
      
      if (transfersToShow.length === 0) {
        statsContainer.innerHTML = '';
        matrixContainer.innerHTML = '';
        noMatrixDataMessage.style.display = 'block';
        return;
      }
      
      noMatrixDataMessage.style.display = 'none';
      
      const totalQueueTransfers = transfersToShow.length;
      const uniqueFromQueues = [...new Set(transfersToShow.map(t => t.fromId))].length;
      const uniqueToQueues = [...new Set(transfersToShow.map(t => t.toId))].length;
      
      statsContainer.innerHTML = `
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${totalQueueTransfers}</div>
          <div class="transfer-stat-label">Queue ‚Üí Queue Transfers</div>
        </div>
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${uniqueFromQueues}</div>
          <div class="transfer-stat-label">Source Queues</div>
        </div>
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${uniqueToQueues}</div>
          <div class="transfer-stat-label">Target Queues</div>
        </div>
      `;
      
      const fromQueues = [...new Set(transfersToShow.map(t => t.fromId))];
      const toQueues = [...new Set(transfersToShow.map(t => t.toId))];
      const allQueueIds = [...new Set([...fromQueues, ...toQueues])];
      
      const matrix = {};
      allQueueIds.forEach(fromQueueId => {
        matrix[fromQueueId] = {};
        allQueueIds.forEach(toQueueId => {
          matrix[fromQueueId][toQueueId] = 0;
        });
      });
      
      transfersToShow.forEach(transfer => {
        if (matrix[transfer.fromId] && matrix[transfer.fromId][transfer.toId] !== undefined) {
          matrix[transfer.fromId][transfer.toId]++;
        }
      });
      
      const sortedQueueIds = allQueueIds.sort((a, b) => {
        const nameA = (getKnownQueueName(a) || '').toLowerCase();
        const nameB = (getKnownQueueName(b) || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      let matrixHtml = '<table class="matrix-table">';
      matrixHtml += '<thead><tr>';
      matrixHtml += '<th class="from-header">FROM / TO</th>';
      sortedQueueIds.forEach(queueId => {
        const queueName = getKnownQueueName(queueId) || getQueueName(queueId);
        matrixHtml += `<th class="to-header">${queueName}</th>`;
      });
      matrixHtml += '</tr></thead>';
      
      matrixHtml += '<tbody>';
      sortedQueueIds.forEach(fromQueueId => {
        const fromQueueName = getKnownQueueName(fromQueueId) || getQueueName(fromQueueId);
        matrixHtml += `<tr><td class="from-label">${fromQueueName}</td>`;
        
        sortedQueueIds.forEach(toQueueId => {
          const count = matrix[fromQueueId][toQueueId];
          let cellClass = '';
          if (count > 0) {
            if (count >= 10) cellClass = 'matrix-high';
            else if (count >= 5) cellClass = 'matrix-medium';
            else cellClass = 'matrix-low';
          }
          matrixHtml += `<td class="${cellClass}"><span class="matrix-count">${count}</span></td>`;
        });
        
        matrixHtml += '</tr>';
      });
      matrixHtml += '</tbody></table>';
      
      matrixContainer.innerHTML = matrixHtml;
    }
    
    // ===== Agent Transfer Matrix (Agent‚ÜíAgent only) =====
    function renderAgentTransferMatrix() {
      const statsContainer = $('agentMatrixStats');
      const matrixContainer = $('agentMatrixContainer');
      const noMatrixDataMessage = $('noAgentMatrixDataMessage');
      const selectedAgentId = $('agentMatrixAgentSelect').value;
      
      let transfersToShow = state.agentTransfers;
      
      if (selectedAgentId !== 'all') {
        const agentConversations = state.conversations.filter(conv => 
          conv.participants && conv.participants.some(p => p.userId === selectedAgentId)
        );
        const agentConversationIds = new Set(agentConversations.map(c => c.conversationId));
        transfersToShow = transfersToShow.filter(t => agentConversationIds.has(t.conversationId));
      }
      
      if (transfersToShow.length === 0) {
        statsContainer.innerHTML = '';
        matrixContainer.innerHTML = '';
        noMatrixDataMessage.style.display = 'block';
        return;
      }
      
      noMatrixDataMessage.style.display = 'none';
      
      const totalAgentTransfers = transfersToShow.length;
      const uniqueFromAgents = [...new Set(transfersToShow.map(t => t.fromId))].length;
      const uniqueToAgents = [...new Set(transfersToShow.map(t => t.toId))].length;
      
      statsContainer.innerHTML = `
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${totalAgentTransfers}</div>
          <div class="transfer-stat-label">Agent ‚Üí Agent Transfers</div>
        </div>
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${uniqueFromAgents}</div>
          <div class="transfer-stat-label">Source Agents</div>
        </div>
        <div class="transfer-stat-card">
          <div class="transfer-stat-number">${uniqueToAgents}</div>
          <div class="transfer-stat-label">Target Agents</div>
        </div>
      `;
      
      const fromAgents = [...new Set(transfersToShow.map(t => t.fromId))];
      const toAgents = [...new Set(transfersToShow.map(t => t.toId))];
      const allAgents = [...new Set([...fromAgents, ...toAgents])];
      
      const matrix = {};
      allAgents.forEach(fromAgent => {
        matrix[fromAgent] = {};
        allAgents.forEach(toAgent => {
          matrix[fromAgent][toAgent] = 0;
        });
      });
      
      transfersToShow.forEach(transfer => {
        if (matrix[transfer.fromId] && matrix[transfer.fromId][transfer.toId] !== undefined) {
          matrix[transfer.fromId][transfer.toId]++;
        }
      });
      
      let matrixHtml = '<table class="matrix-table">';
      matrixHtml += '<thead><tr>';
      matrixHtml += '<th class="from-header">FROM / TO</th>';
      allAgents.forEach(agentId => {
        const agent = state.users.find(u => u.id === agentId);
        const agentName = agent ? agent.name : `Agent ${agentId}`;
        matrixHtml += `<th class="to-header">${agentName}</th>`;
      });
      matrixHtml += '</tr></thead>';
      
      matrixHtml += '<tbody>';
      allAgents.forEach(fromAgentId => {
        const fromAgent = state.users.find(u => u.id === fromAgentId);
        const fromAgentName = fromAgent ? fromAgent.name : `Agent ${fromAgentId}`;
        matrixHtml += `<tr><td class="from-label">${fromAgentName}</td>`;
        
        allAgents.forEach(toAgentId => {
          const count = matrix[fromAgentId][toAgentId];
          let cellClass = '';
          if (count > 0) {
            if (count >= 10) cellClass = 'matrix-high';
            else if (count >= 5) cellClass = 'matrix-medium';
            else cellClass = 'matrix-low';
          }
          
          matrixHtml += `<td class="${cellClass}"><span class="matrix-count">${count}</span></td>`;
        });
        
        matrixHtml += '</tr>';
      });
      matrixHtml += '</tbody></table>';
      
      matrixContainer.innerHTML = matrixHtml;
    }
    
    function setupTransferFilters() {
      $('transferFilter').addEventListener('change', renderTransferReport);
      $('transferSearch').addEventListener('input', renderTransferReport);
      $('queueMatrixAgentSelect').addEventListener('change', renderQueueTransferMatrix);
      $('agentMatrixAgentSelect').addEventListener('change', renderAgentTransferMatrix);
    }

    // ===== Events & Init =====
    $('fetchBtn').addEventListener('click', fetchConversations);
    
    (function init(){
      // Set default dates (last 7 days)
      const today=new Date(); 
      const weekAgo=new Date(); 
      weekAgo.setDate(today.getDate()-7);
      $('fromDate').value = weekAgo.toISOString().slice(0,10);
      $('toDate').value = today.toISOString().slice(0,10);
      
      // Initialize the application
      initAuth();
      setupTransferFilters();
      
      // Make toggle function globally available
      window.toggleTransferDetails = toggleTransferDetails;
    })();
  </script>
</body>
</html>
